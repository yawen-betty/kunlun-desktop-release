import * as fs from 'fs';
import * as path from 'path';
import * as crypto from 'crypto';

// This script scans the local filesystem for bundles and generates a latest.json.
// It assumes that artifacts from all platforms have been downloaded to the expected directory structure.

interface FileInfo {
  signature: string;
  size: number;
}

interface PlatformInfo {
  signature: string;
  url: string;
  size: number;
}

interface LatestJson {
  version: string;
  notes: string;
  pub_date: string;
  platforms: {
    [key: string]: PlatformInfo;
  };
}

class LatestGenerator {
  private encoding: BufferEncoding = 'utf-8';
  private package: any;
  private bundlePath: string;
  private downloadUrl: string;

  constructor() {
    const packageData = fs.readFileSync('package.json', { encoding: this.encoding });
    this.package = JSON.parse(packageData);
    this.bundlePath = path.join('src-tauri', 'target', 'release', 'bundle');

    const env = process.env.APP_ENV || 'dev';
    this.downloadUrl = this.package.config[env].downloadUrl;
    if (!this.downloadUrl) {
      console.error(`Error: downloadUrl is not defined in package.json for the "${env}" environment.`);
      process.exit(1);
    }
  }

  private getFileInfo(filePath: string): FileInfo | null {
    if (!fs.existsSync(filePath)) {
      return null;
    }
    const buffer = fs.readFileSync(filePath);
    const sigFilePath = `${filePath}.sig`;
    if (!fs.existsSync(sigFilePath)) {
      console.warn(`Signature file not found for: ${filePath}`);
      return null; // Return null if signature is missing
    }
    const signatureBuffer = fs.readFileSync(sigFilePath);
    return {
      signature: signatureBuffer.toString().trim(),
      size: buffer.length,
    };
  }

  private findPlatformFiles() {
    const platforms: { [key: string]: PlatformInfo } = {};
    
    // ä¼˜å…ˆæ‰«ææ ¹ç›®å½•ï¼ˆCI/CD äº§ç‰©ä½ç½®ï¼‰
    const rootDir = '.';
    
    // macOS: æ ¹ç›®å½•
    let macosAppTar = path.join(rootDir, 'Kunlun.app.tar.gz');
    let appTarInfo = this.getFileInfo(macosAppTar);
    if (appTarInfo) {
      platforms['darwin-x86_64'] = { ...appTarInfo, url: `${this.downloadUrl}/${path.basename(macosAppTar)}` };
    }
    
    // Windows: æ ¹ç›®å½•
    let windowsMsi = path.join(rootDir, `Kunlun_${this.package.version}_x64_en-US.msi`);
    let winInfo = this.getFileInfo(windowsMsi);
    if (winInfo) {
      platforms['windows-x86_64'] = { ...winInfo, url: `${this.downloadUrl}/${path.basename(windowsMsi)}` };
    }
    
    // å¦‚æœæ ¹ç›®å½•æ²¡æ‰¾åˆ°ï¼Œæ‰«æ bundle ç›®å½•
    const bundleDir = this.bundlePath;
    if (fs.existsSync(bundleDir)) {
      // macOS: bundle ç›®å½•
      if (!platforms['darwin-x86_64']) {
        macosAppTar = path.join(bundleDir, 'macos', 'Kunlun.app.tar.gz');
        appTarInfo = this.getFileInfo(macosAppTar);
        if (appTarInfo) {
          platforms['darwin-x86_64'] = { ...appTarInfo, url: `${this.downloadUrl}/${path.basename(macosAppTar)}` };
        }
      }
      
      // Windows: bundle ç›®å½•
      if (!platforms['windows-x86_64']) {
        windowsMsi = path.join(bundleDir, 'msi', `Kunlun_${this.package.version}_x64_en-US.msi`);
        winInfo = this.getFileInfo(windowsMsi);
        if (winInfo) {
          platforms['windows-x86_64'] = { ...winInfo, url: `${this.downloadUrl}/${path.basename(windowsMsi)}` };
        }
      }
      
      // Linux: bundle ç›®å½•
      const linuxAppImage = path.join(bundleDir, 'appimage', `Kunlun_${this.package.version}_amd64.AppImage`);
      const appImageInfo = this.getFileInfo(linuxAppImage);
      if (appImageInfo) {
        platforms['linux-x86_64'] = { ...appImageInfo, url: `${this.downloadUrl}/${path.basename(linuxAppImage)}` };
      }
    }
    
    return platforms;
  }

  public generate() {
    console.log('Scanning for bundles in root directory and:', this.bundlePath);
    const platforms = this.findPlatformFiles();

    if (Object.keys(platforms).length === 0) {
      console.error('No platform files found after scanning all potential paths.');
      return;
    }

    const pubDate = new Date().toISOString();

    // ç”Ÿæˆç®€åŒ–çš„æ–‡ä»¶å
    // Windows: latest-windows.json
    if (platforms['windows-x86_64']) {
      const windowsJson: LatestJson = {
        version: this.package.version,
        notes: "Generated by CI.",
        pub_date: pubDate,
        platforms: {
          'windows-x86_64': platforms['windows-x86_64']
        },
      };
      const windowsPath = path.join('latest-windows.json');
      fs.writeFileSync(windowsPath, JSON.stringify(windowsJson, null, 2), this.encoding);
      console.log('âœ… Generated latest-windows.json');
    }

    // macOS: latest-macos.json
    if (platforms['darwin-x86_64']) {
      const macJson: LatestJson = {
        version: this.package.version,
        notes: "Generated by CI.",
        pub_date: pubDate,
        platforms: {
          'darwin-x86_64': platforms['darwin-x86_64']
        },
      };
      const macPath = path.join('latest-macos.json');
      fs.writeFileSync(macPath, JSON.stringify(macJson, null, 2), this.encoding);
      console.log('âœ… Generated latest-macos.json');
    }

    // Linux: latest-linux.json
    if (platforms['linux-x86_64']) {
      const linuxJson: LatestJson = {
        version: this.package.version,
        notes: "Generated by CI.",
        pub_date: pubDate,
        platforms: {
          'linux-x86_64': platforms['linux-x86_64']
        },
      };
      const linuxPath = path.join('latest-linux.json');
      fs.writeFileSync(linuxPath, JSON.stringify(linuxJson, null, 2), this.encoding);
      console.log('âœ… Generated latest-linux.json');
    }

    // ä¿ç•™åŸæœ‰çš„ latest.jsonï¼ˆåŒ…å«æ‰€æœ‰å¹³å°ï¼‰
    const latestJson: LatestJson = {
      version: this.package.version,
      notes: "Generated by CI.",
      pub_date: pubDate,
      platforms,
    };
    const outputPath = path.join('latest.json');
    fs.writeFileSync(outputPath, JSON.stringify(latestJson, null, 2), this.encoding);
    console.log('âœ… Generated latest.json (all platforms)');

    console.log('\nğŸ“¦ Summary:');
    console.log('- latest-windows.json:', platforms['windows-x86_64'] ? 'âœ…' : 'âŒ');
    console.log('- latest-macos.json:', platforms['darwin-x86_64'] ? 'âœ…' : 'âŒ');
    console.log('- latest-linux.json:', platforms['linux-x86_64'] ? 'âœ…' : 'âŒ');
    console.log('- latest.json: âœ… (all platforms)');
  }
}

const generator = new LatestGenerator();
generator.generate();
